<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>College Estimate</title>
<style>
  body{font-family:system-ui;margin:16px;max-width:760px}
  .card{border:1px solid #ddd;border-radius:16px;padding:14px}
  label{display:block;margin:10px 0 4px;font-weight:650}
  input,select,button{width:100%;padding:10px;border:1px solid #ccc;border-radius:12px;font-size:16px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .out{margin-top:12px;padding:12px;border-radius:14px;background:#f6f6f6;display:none}
  .small{color:#555;font-size:13px;margin-top:10px}
</style>

<h2>3秒大学金估算  3-Second College Math</h2>

<div class="card">
  <div class="grid">
    <div>
      <label>家长姓名Parent Name</label>
      <input id="name" placeholder="Parent Name">
    </div>
    <div>
      <label>邮箱Email</label>
      <input id="email" type="email" placeholder="Email">
    </div>
  </div>

  <div class="grid">
    <div>
      <label>孩子年级Kid Grade</label>
      <select id="grade">
        <option value="">请选择</option>
        <option>K</option>
        <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
        <option>6</option><option>7</option><option>8</option>
        <option>9</option><option>10</option><option>11</option><option>12</option>
      </select>
    </div>
    <div>
      <label>已为大学存了多少钱（可填0）</label>
      <input id="saved" inputmode="decimal" placeholder="e.g. 0">
    </div>
  </div>

  <label>是否需要预约15分钟咨询（教育金 + Financial Aid 评估）？Willing to have 15 minutes free consultation (Education saving + Financial Aid estimation)?</label>
  <select id="intent">
    <option value="">请选择</option>
    <option>Yes / 需要</option>
    <option>No / 暂时不需要</option>
  </select>

  <button id="go" style="margin-top:12px">立刻计算</button>

  <div id="out" class="out"></div>

  <div class="small">
    假设：4年总费用按 <b>5%</b>/年增长；每月存款按假设<b>年化7%</b>回报、按月复利倒推（模型假设，非承诺回报）。<br>
    你也可以进一步预约咨询评估是否可能申请到 <b>financial aid</b>（需结合收入/资产/学校清单等）。
  </div>
</div>

<script>
  // ✅ Your deployed Apps Script Web App URL (/exec)
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwD_HZ_VPvN7Q8rXleRvwA0ReYgHbGUznqxPM7nB2aD6bmP23_Pm8neozM2BmZqUvLY/exec";

  const $ = id => document.getElementById(id);
  const okmail = s => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test((s||"").trim());
  const num = s => {
    s = (s||"").toString().trim().replace(/,/g,"");
    const n = Number(s);
    return isFinite(n) ? n : 0;
  };
  const fmt = n => Number(n).toLocaleString(undefined,{maximumFractionDigits:0});

  // ✅ Front-end calculation (so results always show)
 function calcCollege(grade, saved) {
  const inflation = 0.05;       // 5% tuition inflation
  const annualReturn = 0.07;    // 7% annual investment return (assumption)
  const publicToday = 120000;   // today's 4-year public total cost
  const privateToday = 320000;  // today's 4-year private total cost

  const g = (grade === "K") ? 0 : Number(grade);
  const years = Math.max(0, 18 - (5 + g)); // K≈5 years old, college≈18
  const months = years * 12;

  const futurePublic  = Math.round(publicToday  * Math.pow(1 + inflation, years));
  const futurePrivate = Math.round(privateToday * Math.pow(1 + inflation, years));

  // monthly return (compounded monthly)
  const r = annualReturn / 12;

  // PMT to reach FV, assuming deposits at end of each month
  function pmtToReachFV(FV, PV, months, r) {
    if (months <= 0) return Math.max(0, FV - PV);

    // existing savings also grows at r
    const PV_fv = PV * Math.pow(1 + r, months);
    const needFV = Math.max(0, FV - PV_fv);
    if (needFV <= 0) return 0;

    const denom = Math.pow(1 + r, months) - 1;
    return Math.ceil(needFV * r / denom);
  }

  const perMonthPublic  = pmtToReachFV(futurePublic,  saved, months, r);
  const perMonthPrivate = pmtToReachFV(futurePrivate, saved, months, r);

  // For display/record: remaining gap in FUTURE dollars after saved grows
  const savedFV = months > 0 ? Math.round(saved * Math.pow(1 + r, months)) : saved;
  const gapPublic  = Math.max(0, futurePublic  - savedFV);
  const gapPrivate = Math.max(0, futurePrivate - savedFV);

  return {
    years, months,
    futurePublic, futurePrivate,
    gapPublic, gapPrivate,
    perMonthPublic, perMonthPrivate
  };
}


  $("go").addEventListener("click", async () => {
    const name = $("name").value.trim();
    const email = $("email").value.trim();
    const grade = $("grade").value.trim();
    const saved = Math.max(0, num($("saved").value));
    const intent = $("intent").value.trim();

    if (!name) return alert("请输入家长姓名");
    if (!okmail(email)) return alert("请输入有效邮箱");
    if (!grade) return alert("请选择孩子年级");
    if (!intent) return alert("请选择是否愿意预约咨询");

    $("go").disabled = true;
    $("go").innerText = "计算中…";

    // ✅ compute first
    const c = calcCollege(grade, saved);

    // ✅ show results immediately
    const out = $("out");
    out.style.display = "block";
    out.innerHTML =
      `<b>结果已生成：</b><br><br>
       距离入学：<b>${c.years}</b> 年（${c.months} 个月）<br><br>
       <b>入学时4年总费用估算（5%年增长）：</b><br>
       • 公立州内：<b>$${fmt(c.futurePublic)}</b><br>
       • 私立：<b>$${fmt(c.futurePrivate)}</b><br><br>
       <b>扣除已存 $${fmt(saved)} 后仍需准备：</b><br>
       • 公立：<b>$${fmt(c.gapPublic)}</b><br>
       • 私立：<b>$${fmt(c.gapPrivate)}</b><br><br>
       <b>建议每月需要存：</b><br>
       • 公立：<b>$${fmt(c.perMonthPublic)}/月</b><br>
       • 私立：<b>$${fmt(c.perMonthPrivate)}/月</b><br><br>
       <span style="color:#555">如选择“需要咨询”，我会主动联系你安排15分钟沟通，并可评估 financial aid 可能性。</span>`;

    try {
      // ✅ Send as real "application/x-www-form-urlencoded" body
      // This helps Apps Script reliably parse parameters.
      const payload = new URLSearchParams({
        name,
        email,
        grade,
        saved: String(saved),
        intent,

        years: String(c.years),
        months: String(c.months),
        futurePublic: String(c.futurePublic),
        futurePrivate: String(c.futurePrivate),
        gapPublic: String(c.gapPublic),
        gapPrivate: String(c.gapPrivate),
        perMonthPublic: String(c.perMonthPublic),
        perMonthPrivate: String(c.perMonthPrivate),

        source: location.href
      });

      await fetch(WEB_APP_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
        body: payload.toString()
      });

      // IMPORTANT: no-cors cannot read response; do not res.json()
    } catch (err) {
      alert("结果已生成，但可能网络限制： " + err.message);
    } finally {
      $("go").disabled = false;
      $("go").innerText = "立刻计算";
    }
  });
</script>
