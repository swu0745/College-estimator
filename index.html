<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>College Estimate</title>
<style>
  body{font-family:system-ui;margin:16px;max-width:760px}
  .card{border:1px solid #ddd;border-radius:16px;padding:14px}
  label{display:block;margin:10px 0 4px;font-weight:650}
  input,select,button{width:100%;padding:10px;border:1px solid #ccc;border-radius:12px;font-size:16px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .out{margin-top:12px;padding:12px;border-radius:14px;background:#f6f6f6;display:none}
  .small{color:#555;font-size:13px;margin-top:10px}
</style>

<h2>大学教育金估算（当场出结果 + 邮件存档）</h2>

<div class="card">
  <div class="grid">
    <div>
      <label>家长姓名</label>
      <input id="name" placeholder="Parent Name">
    </div>
    <div>
      <label>邮箱（结果会发到这里）</label>
      <input id="email" type="email" placeholder="Email">
    </div>
  </div>

  <div class="grid">
    <div>
      <label>孩子年级</label>
      <select id="grade">
        <option value="">请选择</option>
        <option>K</option>
        <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
        <option>6</option><option>7</option><option>8</option>
        <option>9</option><option>10</option><option>11</option><option>12</option>
      </select>
    </div>
    <div>
      <label>已为大学存了多少钱（可填0）</label>
      <input id="saved" inputmode="decimal" placeholder="e.g. 0">
    </div>
  </div>

  <label>是否愿意预约15分钟咨询（教育金 + Financial Aid 评估）？</label>
  <select id="intent">
    <option value="">请选择</option>
    <option>Yes / 愿意</option>
    <option>No / 暂时不需要</option>
  </select>

  <button id="go" style="margin-top:12px">立刻计算（并邮件存档）</button>

  <div id="out" class="out"></div>

  <div class="small">
    假设：4年总费用按 <b>5%</b>/年增长；每月存款为保守预算（不计投资回报）。<br>
    你也可以进一步评估是否可能申请到 <b>financial aid</b>（需结合收入/资产/学校清单等）。
  </div>
</div>

<script>
  // ✅ 改成你部署的 Apps Script Web App URL
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzn4Hx7AnjnapbB8hEVNSxBZzIUbB2dexQ9Lm3uB0qNsHq6uTH8iXFc4e66Lad9IDaa/exec";

  const $ = id => document.getElementById(id);
  const okmail = s => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test((s||"").trim());
  const num = s => {
    s = (s||"").toString().trim().replace(/,/g,"");
    const n = Number(s);
    return isFinite(n) ? n : 0;
  };
  const fmt = n => Number(n).toLocaleString(undefined,{maximumFractionDigits:0});

  // ✅ 前端计算：避免依赖后端返回（no-cors 不能 res.json）
  function calcCollege(grade, saved) {
    const growth = 0.05;          // 5% inflation
    const publicToday = 120000;   // 你可按需调整：当前4年公立总成本假设
    const privateToday = 320000;  // 你可按需调整：当前4年私立总成本假设

    const g = (grade === "K") ? 0 : Number(grade);
    const years = Math.max(0, 18 - (5 + g)); // 粗略：K≈5岁，18岁上大学
    const months = years * 12;

    const futurePublic  = Math.round(publicToday  * Math.pow(1 + growth, years));
    const futurePrivate = Math.round(privateToday * Math.pow(1 + growth, years));

    const gapPublic  = Math.max(0, futurePublic  - saved);
    const gapPrivate = Math.max(0, futurePrivate - saved);

    const perMonthPublic  = months > 0 ? Math.ceil(gapPublic  / months) : gapPublic;
    const perMonthPrivate = months > 0 ? Math.ceil(gapPrivate / months) : gapPrivate;

    return { years, months, futurePublic, futurePrivate, gapPublic, gapPrivate, perMonthPublic, perMonthPrivate };
  }

  $("go").onclick = async () => {
    const name = $("name").value.trim();
    const email = $("email").value.trim();
    const grade = $("grade").value.trim();
    const saved = Math.max(0, num($("saved").value));
    const intent = $("intent").value.trim();

    if (!name) return alert("请输入家长姓名");
    if (!okmail(email)) return alert("请输入有效邮箱");
    if (!grade) return alert("请选择孩子年级");
    if (!intent) return alert("请选择是否愿意预约咨询");

    $("go").disabled = true;
    $("go").innerText = "计算中…";

    // ✅ 先在前端计算并展示（即使网络提交失败，也能出结果）
    const c = calcCollege(grade, saved);

    const out = $("out");
    out.style.display = "block";
    out.innerHTML =
      `<b>结果已生成：</b>（并已尝试提交用于邮件存档）<br><br>
       距离入学：<b>${c.years}</b> 年（${c.months} 个月）<br><br>
       <b>入学时4年总费用估算（5%年增长）：</b><br>
       • 公立州内：<b>$${fmt(c.futurePublic)}</b><br>
       • 私立：<b>$${fmt(c.futurePrivate)}</b><br><br>
       <b>扣除已存 $${fmt(saved)} 后仍需准备：</b><br>
       • 公立：<b>$${fmt(c.gapPublic)}</b><br>
       • 私立：<b>$${fmt(c.gapPrivate)}</b><br><br>
       <b>建议每月需要存（保守、不计投资回报）：</b><br>
       • 公立：<b>$${fmt(c.perMonthPublic)}/月</b><br>
       • 私立：<b>$${fmt(c.perMonthPrivate)}/月</b><br><br>
       <span style="color:#555">如选择“愿意咨询”，我会主动联系你安排15分钟沟通，并可评估 financial aid 可能性。</span>`;

    try {
      // ✅ 用 URLSearchParams + no-cors 避免 CORS/预检问题
      const payload = new URLSearchParams({
        name,
        email,
        grade,
        saved: String(saved),
        intent,

        // 把结果也传给后端，方便你发邮件/记录
        years: String(c.years),
        months: String(c.months),
        futurePublic: String(c.futurePublic),
        futurePrivate: String(c.futurePrivate),
        gapPublic: String(c.gapPublic),
        gapPrivate: String(c.gapPrivate),
        perMonthPublic: String(c.perMonthPublic),
        perMonthPrivate: String(c.perMonthPrivate),

        source: location.href
      });

      await fetch(WEB_APP_URL, {
        method: "POST",
        mode: "no-cors",
        body: payload
      });

      // IMPORTANT: no-cors 模式不能读取响应内容；不要 res.json()
    } catch (err) {
      // no-cors 下浏览器可能不暴露详细原因，这里仅提示“提交可能失败”
      alert("结果已生成，但提交邮件存档可能失败（网络限制）： " + err.message);
    } finally {
      $("go").disabled = false;
      $("go").innerText = "立刻计算（并邮件存档）";
    }
  };
</script>
